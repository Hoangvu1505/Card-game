<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Casino Cam-pu-chia =))</title>
    <style>
        body { background: #1b262c; color: white; font-family: 'Segoe UI', sans-serif; text-align: center; margin: 0; overflow-x: hidden;}
        
        .screen { display: none; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .active { display: block; }

        /* BUTTONS */
        button { padding: 12px 20px; margin: 5px; cursor: pointer; border-radius: 5px; border: none; font-weight: bold; color: white; transition: 0.2s; }
        button:hover { transform: scale(1.05); filter: brightness(1.2); }
        .btn-main { background: #0f4c75; width: 200px; font-size: 18px; margin-bottom: 10px; }
        .btn-green { background: #27ae60; }
        .btn-red { background: #c0392b; }
        .btn-yellow { background: #f1c40f; color: black; }
        .btn-back { background: #95a5a6; color: #fff; float: left; }
        .btn-join { background: #2980b9; color: white; }

        /* CARD */
        .card { 
            display: inline-flex; justify-content: center; align-items: center;
            width: 50px; height: 75px; background: white; color: black; 
            border-radius: 5px; margin: 2px; font-weight: bold; position: relative;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.5); font-size: 16px;
        }
        .card.red { color: #e74c3c; }
        .card-back { 
            background: #34495e; border: 2px solid white; color: white;
            font-size: 24px; display: inline-flex; justify-content: center; align-items: center;
        }
        .hidden-card { background: #a93226; color: #a93226; border: 2px solid white; background-image: repeating-linear-gradient(45deg, #a93226 0, #a93226 5px, #922b21 5px, #922b21 10px);}

        /* LAYOUT & TABLE */
        .home-grid { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top: 50px;}
        .game-card { background: #3282b8; padding: 20px; border-radius: 10px; width: 250px; }
        #room-list { margin-top: 20px; }
        .room-item { background: #0f4c75; padding: 10px; margin: 5px auto; width: 300px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; cursor: pointer;}
        .room-item:hover { background: #3282b8; }
        /* 1. C√ÅI B√ÄN (QUAN TR·ªåNG NH·∫§T: position: relative) */
        #tlmn-table {
            position: relative; /* <--- D√íNG N√ÄY QUY·∫æT ƒê·ªäNH VI·ªÜC KH√ìA GH·∫æ V√ÄO B√ÄN */
            width: 800px; 
            height: 600px; 
            background: #206a5d; 
            border-radius: 200px; 
            border: 15px solid #1b262c;
            margin: 0 auto; /* CƒÉn gi·ªØa b√†n ra gi·ªØa m√†n h√¨nh */
            margin-top: 50px;
            margin-bottom: 50px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* 2. C√ÅC GH·∫æ (N·∫±m g·ªçn trong b√†n) */
        .seat { 
            position: absolute; /* Tuy·ªát ƒë·ªëi theo cha (l√† c√°i b√†n) */
            width: 120px; 
            text-align: center; 
            z-index: 20; 
        }
        
        /* Gh·∫ø 0 (B·∫°n): ·ªû m√©p d∆∞·ªõi, h∆°i ch·ªùm ra ngo√†i x√≠u cho ƒë·∫πp */
        .seat-0 { 
            bottom: -30px; 
            left: 50%; 
            transform: translateX(-50%); 
        } 
        
        /* Gh·∫ø 1 (Ph·∫£i): Th·ª•t v√†o trong 20px */
        .seat-1 { 
            right: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
        }   
        
        /* Gh·∫ø 2 (ƒê·ªëi th·ªß): Th·ª•t v√†o trong 20px */
        .seat-2 { 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
        }    
        
        /* Gh·∫ø 3 (Tr√°i): Th·ª•t v√†o trong 20px */
        .seat-3 { 
            left: 20px; 
            top: 50%; 
            transform: translateY(-50%); 
        }
        .avatar { width: 60px; height: 60px; background: #bbb; border-radius: 50%; margin: 0 auto; line-height: 60px; color: #333; font-weight: bold; border: 3px solid transparent; position: relative;}
        .active-turn .avatar { border-color: yellow; box-shadow: 0 0 15px yellow; transform: scale(1.1); transition: 0.3s;}
        #table-center { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 300px; height: 150px; display: flex; justify-content: center; align-items: center;
        }
        .card-checkbox { display: none; }
        .card-checkbox:checked + .card { transform: translateY(-15px); border: 2px solid gold; }

        /* WINNER POPUP & EFFECTS */
        #winner-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            justify-content: center; align-items: center; animation: fadeIn 0.3s;
        }
        .winner-box {
            background: linear-gradient(135deg, #f1c40f, #e67e22); padding: 40px; border-radius: 20px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.8); text-align: center; color: white;
            border: 5px solid #fff; transform: scale(0.8); animation: popIn 0.5s forwards;
        }
        .winner-badge {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(45deg, #f1c40f, #e67e22); color: white; padding: 5px 15px; 
            border-radius: 20px; font-weight: bold; font-size: 14px;
            box-shadow: 0 0 10px #f1c40f; border: 2px solid white; white-space: nowrap; z-index: 10; animation: bounce 1s infinite;
        }
        .funny-gif { position: absolute; pointer-events: none; z-index: 0; opacity: 0.8; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-20px); } }
        .floating { animation: float 3s ease-in-out infinite; }
        @keyframes bounce { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { to { transform: scale(1); } }

        /* --- CHAT SYSTEM (M·ªöI) --- */
        .chat-btn {
            position: absolute; top: 0; right: -50px; /* ƒê·∫©y h·∫≥n sang ph·∫£i */
            width: 45px; height: 45px; border-radius: 50%;
            background: #fff; border: 3px solid #0f4c75; color: #0f4c75;
            font-size: 24px; cursor: pointer; z-index: 999; /* Lu√¥n n·ªïi */
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
        }
        .chat-btn:hover { background: #f1c40f; transform: scale(1.1); }

        .chat-bubble {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: white; color: black; padding: 12px; border-radius: 15px;
            font-weight: bold; min-width: 80px; max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            display: none; z-index: 300; text-align: center; font-size: 16px;
            border: 2px solid #0f4c75;
        }
        .chat-bubble::after { 
            content: ''; position: absolute; bottom: -10px; left: 50%; margin-left: -10px;
            border-width: 10px; border-style: solid; border-color: #0f4c75 transparent transparent transparent;
        }
        .chat-bubble img { width: 100%; height: auto; border-radius: 5px; min-width: 250px; }

        #chat-popup {
            display: none; position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            width: 300px; background: rgba(0,0,0,0.9); padding: 10px; border-radius: 10px;
            grid-template-columns: repeat(4, 1fr); gap: 8px; z-index: 999; border: 2px solid #f1c40f;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .chat-input-row {
            grid-column: span 4; display: flex; gap: 5px; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px;
        }
        .chat-input-row input { flex: 1; padding: 8px; border-radius: 5px; border: none; outline: none;}
        .chat-input-row button { padding: 5px 15px; background: #27ae60; border-radius: 5px; font-size: 14px;}

        .sticker-item { cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 5px; background: rgba(255,255,255,0.1); display: flex; justify-content: center; align-items: center;}
        .sticker-item:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .sticker-item img { width: 100%; max-height: 50px; object-fit: contain;}
        /* ƒê·ªäNH V·ªä N√öT B·∫§M TR√äN B√ÄN */
        #game-controls, #btn-start {
            position: absolute;
            bottom: 80px; /* C√°ch m√©p d∆∞·ªõi b√†n 120px -> N·∫±m cao h∆°n b√†i c·ªßa b·∫°n */
            left: 50%;
            transform: translateX(-50%);
            z-index: 50; /* N·ªïi l√™n tr√™n c√πng */
            display: flex; gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
        }
        
        /* Ch·ªânh n√∫t B·∫Øt ƒë·∫ßu to ƒë·∫πp h∆°n ch√∫t */
        #btn-start {
            padding: 15px 40px;
            font-size: 20px;
            box-shadow: 0 0 10px rgba(0,255,0,0.5);
            animation: bounce 2s infinite;
        }
        /* CSS CARO (Th√™m v√†o ph·∫ßn style) */
        #caro-board {
            display: grid;
            grid-template-columns: repeat(15, 30px); /* 15 c·ªôt */
            grid-template-rows: repeat(15, 30px);    /* 15 d√≤ng */
            gap: 1px;
            background: #95a5a6;
            width: fit-content;
            margin: 0 auto;
            border: 5px solid #34495e;
            padding: 5px;
        }
        .cell {
            width: 30px; height: 30px;
            background: #fff;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; font-weight: bold; cursor: pointer; color: black;
        }
        .cell:hover { background: #ecf0f1; }
        .cell.x { color: red; }
        .cell.o { color: blue; }
        
        /* Hi·ªáu ·ª©ng s√°ng ƒë√®n l∆∞·ª£t ƒëi */
        .active-turn-box { 
            background: yellow !important; 
            color: black !important; 
            box-shadow: 0 0 10px yellow; 
            transform: scale(1.1); 
            transition: 0.3s;
            font-weight: bold;
        }
        /* Hi·ªáu ·ª©ng √¥ v·ª´a ƒë√°nh: N·ªÅn xanh l∆°, ph√°t s√°ng, h∆°i to l√™n */
        .last-move {
            background-color: #00bcd4 !important; 
            box-shadow: 0 0 10px #00bcd4;
            transform: scale(1.1);
            border: 2px solid white !important;
            z-index: 10; /* N·ªïi l√™n tr√™n */
            transition: 0.2s;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>

    <div id="winner-overlay">
        <div class="winner-box">
            <div class="winner-title">üèÜ NG∆Ø·ªúI CHI·∫æN TH·∫ÆNG üèÜ</div>
            <div id="winner-name-display" class="winner-name">T√™n ng∆∞·ªùi th·∫Øng</div>
            <div id="winner-message">Ch√∫c m·ª´ng! B·∫°n ƒë√£ ch∆°i r·∫•t hay.</div>
            <br>
            <button class="btn-green" style="font-size: 20px; padding: 15px 30px;" onclick="closeWinnerPopup()">ƒê√≥ng & Ch∆°i Ti·∫øp</button>
        </div>
    </div>

    <div id="home-screen" class="screen active">
        <img src="https://media.giphy.com/media/GeimqsH0TLDt4tScGw/giphy.gif" class="funny-gif floating" style="bottom: 10px; left: 10px; width: 150px;">
        <img src="https://ss-images.saostar.vn/2018/12/31/4357621/tenor.gif" class="funny-gif" style="top: 20px; right: 20px; width: 120px;">
        
        <h1>üòùüòù‚ô†Ô∏è CASINO Cam-pu-chia ‚ô£Ô∏èüòè</h1>
        <div style="margin: 20px 0;">
            <label for="username" style="font-size: 18px; font-weight: bold; margin-right: 10px;">Nh·∫≠p t√™n c·ªßa b·∫°n:</label>
            <input type="text" id="username" placeholder="Nh·∫≠p t√™n b·∫°n" value="Player 1" style="padding: 10px; border-radius: 5px; border: none; font-size: 16px; color: #333; width: 200px;">
        </div>
        
        <div class="home-grid">
            <div class="game-card">
                <h2>X√¨ D√°ch</h2>
                <p>Ch·ªâ ƒë√°nh v·ªõi m√°y</p>
                <button class="btn-main" onclick="startBlackjack()">Ch∆°i Ngay</button>
            </div>
            <div class="game-card">
                <h2>Ti·∫øn L√™n MN</h2>
                <p>Bot & Online</p>
                <button class="btn-main" onclick="showTLMNMenu()">Ch∆°i ngay</button>
            </div>
            <div class="game-card" style="opacity: 0.5;">
                <h2>Poker</h2>
                <p>(Demo - Ch∆∞a c√≥)</p>
                <button class="btn-main" disabled>S·∫Øp ra m·∫Øt</button>
            </div>
            <div class="game-card" style="background: #e67e22;">
                <h2>C·ªù Caro</h2>
                <p>X vs O (5 Win)</p>
                <button class="btn-main" onclick="showCaroMenu()">Ch∆°i ngay</button>
            </div>
        </div>
    </div>

    <div id="tlmn-lobby" class="screen">
        <button class="btn-back" onclick="goHome()">‚¨Ö Quay l·∫°i</button>
        <h2>S·∫£nh Ti·∫øn L√™n</h2>
        <div style="display: flex; justify-content: center; gap: 20px;">
            <div style="width: 300px; border-right: 1px solid #555; padding-right: 20px;">
                <h3>Ch∆°i Nhanh</h3>
                <button class="btn-main btn-green" onclick="createTLMN('bot')">ƒê√°nh v·ªõi M√°y</button>
                <br>
                <button class="btn-main btn-green" onclick="createTLMN('multi')">T·∫°o Ph√≤ng Online</button>
                <br>
                <input type="text" id="room-code-input" placeholder="M√£ ph√≤ng" style="width: 100px; padding: 8px;">
                <button class="btn-join" onclick="joinByCode()">V√†o</button>
            </div>
            <div style="width: 400px;">
                <h3>Danh s√°ch ph√≤ng online</h3>
                <div id="room-list">ƒêang t·∫£i...</div>
            </div>
        </div>
    </div>
    
    <div id="caro-lobby" class="screen">
        <button class="btn-back" onclick="goHome()">‚¨Ö Quay l·∫°i</button>
        <h2 style="color: #e67e22;">C·ªù Caro</h2>
        
        <div style="display: flex; justify-content: center; gap: 20px;">
            <div style="width: 300px; border-right: 1px solid #555; padding-right: 20px;">
                <h3>Ch∆°i Nhanh</h3>
                <button class="btn-main btn-green" onclick="createCaro('bot')">ƒê·∫•u v·ªõi M√°y</button>
                <br>
                <button class="btn-main btn-green" onclick="createCaro('multi')">T·∫°o Ph√≤ng Online</button>
                <br>
                <div style="margin-top: 10px;">
                    <input type="text" id="caro-code-input" placeholder="M√£ ph√≤ng" style="padding: 10px; width: 120px; border-radius: 5px; border: none;">
                    <button class="btn-join" onclick="joinCaroByInput()">V√†o</button>
                </div>
            </div>

            <div style="width: 400px;">
                <h3>Danh s√°ch ph√≤ng</h3>
                <div id="caro-room-list">
                    <p style="opacity: 0.7;">(Ch·ª©c nƒÉng danh s√°ch ƒëang c·∫≠p nh·∫≠t...)</p>
                    <p>H√£y d√πng "M√£ ph√≤ng" ƒë·ªÉ m·ªùi b·∫°n b√®.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="caro-game" class="screen">
        <button class="btn-back" onclick="leaveRoom('caro')">‚¨Ö Tho√°t</button>
        <h2 id="caro-status" style="margin-top: 0;">C·ªù Caro - Ph√≤ng: <span id="caro-rid"></span></h2>
        
        <button class="chat-btn" style="top: 60px; right: 20px;" onclick="toggleCaroChat()">üí¨</button>

        <div style="display: flex; justify-content: center; align-items: flex-end; gap: 0px; margin-top: 20px;">
            
            <div id="wrapper-x" style="position: relative; text-align: center; padding-bottom: 50px; margin-right: 10px;">
                <div class="chat-bubble" style="bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; white-space: nowrap;"></div> 
                <div id="player-x" style="padding: 15px; border: 3px solid white; border-radius: 15px; width: 130px; background: #2c3e50; font-weight: bold; font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    X: Ch·ªù...
                </div>
            </div>

            <div id="caro-board"></div>
            
            <div id="wrapper-o" style="position: relative; text-align: center; padding-bottom: 50px; margin-left: 10px;">
                <div class="chat-bubble" style="bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; white-space: nowrap;"></div> 
                <div id="player-o" style="padding: 15px; border: 3px solid white; border-radius: 15px; width: 130px; background: #2c3e50; font-weight: bold; font-size: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
                    O: Ch·ªù...
                </div>
            </div>

        </div>

        </div>

        <div id="caro-controls" style="text-align: center; margin-top: -90px; display: none; position: relative; z-index: 100;">
            <button class="btn-green" style="font-size: 18px; padding: 10px 30px;" onclick="socket.emit('caro_restart')">üîÑ V√ÅN M·ªöI</button>
        </div>

        <div id="caro-chat-popup" class="chat-popup" style="display: none; position: absolute; bottom: 100px; right: 20px; width: 300px; background: rgba(0,0,0,0.9); padding: 10px; border-radius: 10px; grid-template-columns: repeat(4, 1fr); gap: 8px; z-index: 999; border: 2px solid #f1c40f;">
            <div class="chat-input-row">
                <input type="text" id="caro-chat-msg" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="checkCaroEnter(event)">
                <button onclick="sendCaroText()">G·ª≠i</button>
            </div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'üòÇ')">üòÇ</div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'üò°')">üò°</div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'üò≠')">üò≠</div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'üòé')">üòé</div>
            <div class="sticker-item" onclick="sendCaroChat('text', '‚è≥')">‚è≥</div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'üòè')">üòè</div>
            <div class="sticker-item" onclick="sendCaroChat('text', 'Nhanh l√™n m√°!')">nhanh l√™n m√°!</div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media.giphy.com/media/GeimqsH0TLDt4tScGw/giphy.gif')"><img src="https://media.giphy.com/media/GeimqsH0TLDt4tScGw/giphy.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media.giphy.com/media/H5C8CevNMbpBqNqFjl/giphy.gif')"><img src="https://media.giphy.com/media/H5C8CevNMbpBqNqFjl/giphy.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://ss-images.saostar.vn/2018/12/31/4357621/tenor.gif')"><img src="https://ss-images.saostar.vn/2018/12/31/4357621/tenor.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media1.tenor.com/m/wzDpyUZ3_xQAAAAC/hello-%E4%BD%A0%E5%A5%BD.gif')"><img src="https://media1.tenor.com/m/wzDpyUZ3_xQAAAAC/hello-%E4%BD%A0%E5%A5%BD.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media.tenor.com/EX6You2MNyUAAAAM/chowyunfat-godofgamblers.gif')"><img src="https://media.tenor.com/EX6You2MNyUAAAAM/chowyunfat-godofgamblers.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media1.tenor.com/m/-z_M-8I9ULYAAAAd/stephen-chow-dewa-judi.gif')"><img src="https://media1.tenor.com/m/-z_M-8I9ULYAAAAd/stephen-chow-dewa-judi.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWN0MHd0ZWc2NzIwNGVmNHh3MzJsdG1qMzF4aXh6M2dvOW5laHloOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/d9A3OAEoPMsSEMcRPy/giphy.gif')"><img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWN0MHd0ZWc2NzIwNGVmNHh3MzJsdG1qMzF4aXh6M2dvOW5laHloOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/d9A3OAEoPMsSEMcRPy/giphy.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNzZwMG9pcTN0ZzF6M28xaXV0cndpeGhmb3B2ODltcGQ4M2pheXF1dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/R312C3MEVg4SCYAber/giphy.gif')"><img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNzZwMG9pcTN0ZzF6M28xaXV0cndpeGhmb3B2ODltcGQ4M2pheXF1dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/R312C3MEVg4SCYAber/giphy.gif"></div>
            <div class="sticker-item" onclick="sendCaroChat('image', 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ203Nzh0MzdobHhwcXNseWgxbjRmaTE3azdmYWxtemNsaDhqY2J1NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KFuXeADlsfCFCoxfUB/giphy.gif')"><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ203Nzh0MzdobHhwcXNseWgxbjRmaTE3azdmYWxtemNsaDhqY2J1NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KFuXeADlsfCFCoxfUB/giphy.gif"></div>
        </div>
        </div>
    <div id="tlmn-game" class="screen">
        
        <div style="position: absolute; top: 10px; left: 10px;">
            <button class="btn-red" onclick="leaveRoom('tlmn')">R·ªùi ph√≤ng</button>
            <span id="rid-display" style="margin-left: 10px; font-weight: bold; color: yellow;"></span>
        </div>
        
        <div id="tlmn-table">
            <div class="seat seat-0" id="seat-0"></div>
            <div class="seat seat-1" id="seat-1"></div>
            <div class="seat seat-2" id="seat-2"></div>
            <div class="seat seat-3" id="seat-3"></div>
            <div id="chat-popup">
                <div class="chat-input-row">
                    <input type="text" id="chat-msg" placeholder="Nh·∫≠p tin nh·∫Øn..." onkeydown="checkEnter(event)">
                    <button onclick="sendText()">G·ª≠i</button>
                </div>
                <div class="sticker-item" onclick="sendChat('text', 'üòÇ')">üòÇ</div>
                <div class="sticker-item" onclick="sendChat('text', 'üò°')">üò°</div>
                <div class="sticker-item" onclick="sendChat('text', 'üò≠')">üò≠</div>
                <div class="sticker-item" onclick="sendChat('text', 'üòé')">üòé</div>
                <div class="sticker-item" onclick="sendChat('text', '‚è≥')">‚è≥</div>
                <div class="sticker-item" onclick="sendChat('text', 'üòè')">üòè</div>
                <div class="sticker-item" onclick="sendChat('text', 'Nhanh l√™n m√°!')">nhanh l√™n m√°!</div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media.giphy.com/media/GeimqsH0TLDt4tScGw/giphy.gif')"><img src="https://media.giphy.com/media/GeimqsH0TLDt4tScGw/giphy.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media.giphy.com/media/H5C8CevNMbpBqNqFjl/giphy.gif')"><img src="https://media.giphy.com/media/H5C8CevNMbpBqNqFjl/giphy.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://ss-images.saostar.vn/2018/12/31/4357621/tenor.gif')"><img src="https://ss-images.saostar.vn/2018/12/31/4357621/tenor.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media1.tenor.com/m/wzDpyUZ3_xQAAAAC/hello-%E4%BD%A0%E5%A5%BD.gif')"><img src="https://media1.tenor.com/m/wzDpyUZ3_xQAAAAC/hello-%E4%BD%A0%E5%A5%BD.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media.tenor.com/EX6You2MNyUAAAAM/chowyunfat-godofgamblers.gif')"><img src="https://media.tenor.com/EX6You2MNyUAAAAM/chowyunfat-godofgamblers.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media1.tenor.com/m/-z_M-8I9ULYAAAAd/stephen-chow-dewa-judi.gif')"><img src="https://media1.tenor.com/m/-z_M-8I9ULYAAAAd/stephen-chow-dewa-judi.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWN0MHd0ZWc2NzIwNGVmNHh3MzJsdG1qMzF4aXh6M2dvOW5laHloOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/d9A3OAEoPMsSEMcRPy/giphy.gif')"><img src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExcWN0MHd0ZWc2NzIwNGVmNHh3MzJsdG1qMzF4aXh6M2dvOW5laHloOCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/d9A3OAEoPMsSEMcRPy/giphy.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNzZwMG9pcTN0ZzF6M28xaXV0cndpeGhmb3B2ODltcGQ4M2pheXF1dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/R312C3MEVg4SCYAber/giphy.gif')"><img src="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNzZwMG9pcTN0ZzF6M28xaXV0cndpeGhmb3B2ODltcGQ4M2pheXF1dyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/R312C3MEVg4SCYAber/giphy.gif"></div>
                <div class="sticker-item" onclick="sendChat('image', 'https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ203Nzh0MzdobHhwcXNseWgxbjRmaTE3azdmYWxtemNsaDhqY2J1NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KFuXeADlsfCFCoxfUB/giphy.gif')"><img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ203Nzh0MzdobHhwcXNseWgxbjRmaTE3azdmYWxtemNsaDhqY2J1NyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/KFuXeADlsfCFCoxfUB/giphy.gif"></div>
            </div>
            </div>
            

            <div id="table-center"></div>
        </div>

        <div id="game-controls" style=" display: none;">
            <button class="btn-green" onclick="tlmnAction('play')">ƒê√ÅNH B√ÄI</button>
            <button class="btn-red" onclick="tlmnAction('pass')">B·ªé L∆Ø·ª¢T</button>
        </div>
        <button id="btn-start" class="btn-green" style="margin-top: 10px; display: none;" onclick="socket.emit('tlmn_start_game')">B·∫ÆT ƒê·∫¶U</button>
    </div>

    <div id="blackjack-game" class="screen">
        <button class="btn-back" onclick="leaveRoom('blackjack')">‚¨Ö Tho√°t</button>
        <h1>X√¨ D√°ch (Blackjack)</h1>
        <div class="bj-area">
            <h3>üëë Nh√† C√°i (M√°y)</h3>
            <div id="bj-dealer-cards"></div>
            <div id="bj-dealer-score">ƒêi·ªÉm: ?</div>
        </div>
        <br>
        <div class="bj-area">
            <h3>üë§ B·∫°n</h3>
            <div id="bj-my-cards"></div>
            <div id="bj-my-score">ƒêi·ªÉm: 0</div>
            <div id="bj-controls" style="display:none; margin-top: 15px;">
                <button class="btn-yellow" onclick="bjAction('hit')">R√öT B√ÄI</button>
                <button class="btn-red" onclick="bjAction('stand')">D·∫∞N (TH√îI)</button>
            </div>
            <button id="bj-btn-start" class="btn-green" onclick="startBlackjack()" style="display:none; margin-top:15px;">CHIA B√ÄI L·∫†I</button>
        </div>
    </div>

    <script>
        const socket = io();
        let currentScreen = 'home';

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            currentScreen = id;
        }
        function goHome() { showScreen('home-screen'); }
        function showTLMNMenu() { showScreen('tlmn-lobby'); }
        
        function renderCard(c) {
            if(!c || c == "??") return `<div class="card hidden-card"></div>`;
            let rank = c.slice(0, -1);
            let suit = c.slice(-1);
            const isRed = (suit === '‚ô•' || suit === '‚ô¶');
            return `<div class="card ${isRed ? 'red' : ''}">${rank}<small>${suit}</small></div>`;
        }

        function leaveRoom(type) {
            if(type === 'tlmn') {
                socket.emit('tlmn_action', {act: 'leave'});
                
                // --- TH√äM ƒêO·∫†N N√ÄY ƒê·ªÇ X√ìA N√öT KHI R·ªúI PH√íNG ---
                // 1. ·∫®n c·ª•m n√∫t ƒê√°nh b√†i / B·ªè l∆∞·ª£t
                document.getElementById('game-controls').style.display = 'none';
                
                // 2. ·∫®n n√∫t B·∫Øt ƒë·∫ßu / Ch∆°i l·∫°i & Reset ch·ªØ v·ªÅ m·∫∑c ƒë·ªãnh
                const startBtn = document.getElementById('btn-start');
                startBtn.style.display = 'none';
                startBtn.innerText = "B·∫ÆT ƒê·∫¶U"; 
                
                // 3. (T√πy ch·ªçn) X√≥a b√†i tr√™n b√†n ƒë·ªÉ l·∫ßn sau v√†o nh√¨n cho s·∫°ch
                document.getElementById('table-center').innerHTML = '';
                // ------------------------------------------------
            } 
            else if (type === 'caro') {
                socket.emit('caro_leave'); 
            }
            goHome();
        }

        function closeWinnerPopup() {
            document.getElementById('winner-overlay').style.display = 'none';
        }

        function createTLMN(mode) {
            const name = document.getElementById('username').value;
            socket.emit('create_tlmn', {mode: mode, name: name});
        }
        function joinByCode() {
            const code = document.getElementById('room-code-input').value.toUpperCase();
            const name = document.getElementById('username').value;
            socket.emit('join_tlmn', {code: code, name: name});
        }
        function joinRoom(id) {
            const name = document.getElementById('username').value;
            socket.emit('join_tlmn', {code: id, name: name});
        }
        function tlmnAction(act) {
            if (act === 'pass') {
                socket.emit('tlmn_action', {act: 'pass'});
            } else {
                const checked = document.querySelectorAll('.card-checkbox:checked');
                const cards = Array.from(checked).map(c => c.value);
                if (cards.length === 0) return alert("Ch·ªçn b√†i ƒëi!");
                socket.emit('tlmn_action', {act: 'play', cards: cards});
            }
        }

        // --- 1. X·ª¨ L√ù DANH S√ÅCH PH√íNG (N√ÇNG C·∫§P) ---
        socket.on('room_list_update', (rooms) => {
            // Danh s√°ch Ti·∫øn L√™n
            const tlmnList = document.getElementById('room-list');
            if (tlmnList) {
                // L·ªçc ph√≤ng KH√îNG PH·∫¢I Caro (ID kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng 'C-')
                const tlmnRooms = rooms.filter(r => !r.id.startsWith('C-'));
                if (tlmnRooms.length === 0) tlmnList.innerHTML = "<p>Ch∆∞a c√≥ ph√≤ng.</p>";
                else tlmnList.innerHTML = tlmnRooms.map(r => `
                    <div class="room-item" onclick="joinRoom('${r.id}')">
                        <span><b>${r.id}</b></span>
                        <span>${r.players} - ${r.host}</span>
                    </div>`).join('');
            }

            // Danh s√°ch Caro (M·ªõi)
            const caroList = document.getElementById('caro-room-list');
            if (caroList) {
                // L·ªçc ph√≤ng Caro (ID b·∫Øt ƒë·∫ßu b·∫±ng 'C-')
                const caroRooms = rooms.filter(r => r.id.startsWith('C-'));
                if (caroRooms.length === 0) caroList.innerHTML = "<p>Ch∆∞a c√≥ ph√≤ng.</p>";
                else caroList.innerHTML = caroRooms.map(r => `
                    <div class="room-item" onclick="joinCaroRoom('${r.id}')">
                        <span><b>${r.id}</b></span>
                        <span>${r.players} - ${r.host}</span>
                    </div>`).join('');
            }
        });



        // --- C·∫¨P NH·∫¨T GIAO DI·ªÜN (CH√çNH) ---
        socket.on('tlmn_update', (data) => {
            data.seats.forEach((seat, index) => {
                const div = document.getElementById(`seat-${index}`);
                if (!seat) { div.innerHTML = `<div class="avatar" style="opacity:0.3">+</div>`; return; }
                
                let cardsHtml = '';
                if (index === 0) {
                    cardsHtml = '<div style="display:flex; justify-content:center; width: 400px; flex-wrap:wrap;">' + 
                        seat.hand.map(c => `<label><input type="checkbox" class="card-checkbox" value="${c}">${renderCard(c)}</label>`).join('') + '</div>';
                } else {
                    if (seat.is_winner) cardsHtml = ''; 
                    else cardsHtml = `<div class="card card-back">${seat.hand}</div>`; 
                }

                // --- N√öT CHAT (Lu√¥n hi·ªán ·ªü gh·∫ø m√¨nh) ---
                let chatBtnHtml = '';
                if (index === 0) {
                    chatBtnHtml = `<button class="chat-btn" onclick="toggleChatPopup()">üí¨</button>`;
                }

                // --- BONG B√ìNG CHAT ---
                let bubbleHtml = `<div id="chat-bubble-${seat.sid}" class="chat-bubble"></div>`;

                let winnerHtml = '';
                if (seat.is_winner) {
                    winnerHtml = `<div class="winner-badge">üëë CHI·∫æN TH·∫ÆNG üëë</div>`;
                    div.classList.add('active-turn');
                } else {
                    if (seat.is_turn) div.classList.add('active-turn');
                    else div.classList.remove('active-turn');
                }

                div.className = `seat seat-${index} ${seat.is_turn || seat.is_winner ? 'active-turn' : ''}`;
                
                // Render ƒë·∫ßy ƒë·ªß
                div.innerHTML = `${winnerHtml}${bubbleHtml}${chatBtnHtml}<div class="avatar">${seat.name}</div>${cardsHtml}`;
            });

            const centerDiv = document.getElementById('table-center');
            centerDiv.innerHTML = (data.last_move && data.last_move.length > 0) ? data.last_move.map(renderCard).join('') : "";

            const startBtn = document.getElementById('btn-start');
        if (data.is_host && (data.state === 'WAITING' || data.state === 'FINISHED') && data.state !== 'PLAYING') {
            startBtn.style.display = 'block';
            startBtn.innerText = (data.state === 'FINISHED') ? "CH∆†I L·∫†I" : "B·∫ÆT ƒê·∫¶U";
        } else {
            startBtn.style.display = 'none';
        }
            document.getElementById('game-controls').style.display = (data.seats[0] && data.seats[0].is_turn) ? 'block' : 'none';
        });

        // --- H√ÄM X·ª¨ L√ù CHAT (M·ªöI) ---
        function toggleChatPopup() {
            const popup = document.getElementById('chat-popup');
            popup.style.display = (popup.style.display === 'grid') ? 'none' : 'grid';
            // Focus v√†o √¥ nh·∫≠p khi m·ªü
            if (popup.style.display === 'grid') document.getElementById('chat-msg').focus();
        }

        function sendText() {
            const input = document.getElementById('chat-msg');
            const text = input.value.trim();
            if (text) {
                sendChat('text', text);
                input.value = ''; // X√≥a √¥ nh·∫≠p sau khi g·ª≠i
            }
        }
        
        function checkEnter(e) {
            if (e.key === "Enter") sendText();
        }

        function sendChat(type, content) {
            socket.emit('send_chat', {type: type, content: content});
            toggleChatPopup(); 
        }

        socket.on('chat_received', (data) => {
            console.log("üì© ƒê√£ nh·∫≠n tin nh·∫Øn v·ªÅ:", data);
            
            // T√¨m bong b√≥ng theo ID ng∆∞·ªùi g·ª≠i
            const bubbleId = `chat-bubble-${data.sender_sid}`;
            const bubble = document.getElementById(bubbleId);
            
            if (bubble) {
                console.log("‚úÖ T√¨m th·∫•y bong b√≥ng, ƒëang hi·ªÉn th·ªã...");
                if (data.type === 'text') {
                    bubble.innerText = data.content;
                } else if (data.type === 'image') {
                    bubble.innerHTML = `<img src="${data.content}">`;
                }
                
                bubble.style.display = 'block';
                if (bubble.hideTimeout) clearTimeout(bubble.hideTimeout);
                bubble.hideTimeout = setTimeout(() => { bubble.style.display = 'none'; }, 5000);
            } else {
                console.error(`‚ùå KH√îNG T√åM TH·∫§Y BONG B√ìNG V·ªöI ID: ${bubbleId}`);
                console.log("Danh s√°ch c√°c ID ƒëang c√≥ tr√™n b√†n:", 
                    Array.from(document.querySelectorAll('.chat-bubble')).map(el => el.id)
                );
            }
        });

        socket.on('tlmn_end', (data) => {
            const winner = data.winner;
            const myName = document.getElementById('username').value;
            document.getElementById('winner-name-display').innerText = winner;
            if (winner === myName || winner === "B·∫°n") {
                document.getElementById('winner-message').innerText = "üéâ XU·∫§T S·∫ÆC! B·∫†N ƒê√É CHI·∫æN TH·∫ÆNG üéâ";
                document.querySelector('.winner-box').style.background = "linear-gradient(135deg, #2ecc71, #27ae60)";
            } else {
                document.getElementById('winner-message').innerText = "üò¢ Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau...";
                document.querySelector('.winner-box').style.background = "linear-gradient(135deg, #e74c3c, #c0392b)";
            }
            document.getElementById('winner-overlay').style.display = 'flex';
        });

        // Blackjack
        function startBlackjack() {
            showScreen('blackjack-game');
            document.getElementById('bj-dealer-cards').innerHTML = "";
            document.getElementById('bj-my-cards').innerHTML = "";
            document.getElementById('bj-controls').style.display = 'none';
            document.getElementById('bj-btn-start').style.display = 'none';
            socket.emit('start_blackjack_pvc');
        }
        function bjAction(act) { socket.emit('action', {act: act}); }

        socket.on('deal_cards', (data) => {
            document.getElementById('bj-btn-start').style.display = 'none';
            document.getElementById('bj-my-cards').innerHTML = data.hand.map(renderCard).join('');
            document.getElementById('bj-my-score').innerText = "ƒêi·ªÉm: " + data.score;
            document.getElementById('bj-dealer-cards').innerHTML = data.dealer_view.map(renderCard).join('');
            document.getElementById('bj-controls').style.display = 'block';
        });
        socket.on('update_hand', (data) => {
            const current = document.getElementById('bj-my-cards').innerHTML;
            const newCard = data.hand[data.hand.length - 1];
            document.getElementById('bj-my-cards').innerHTML = current + renderCard(newCard);
            document.getElementById('bj-my-score').innerText = "ƒêi·ªÉm: " + data.score;
            if(data.score > 21) document.getElementById('bj-controls').style.display = 'none';
        });
        socket.on('game_over', (data) => {
            document.getElementById('bj-dealer-cards').innerHTML = data.dealer_hand.map(renderCard).join('');
            document.getElementById('bj-dealer-score').innerText = "ƒêi·ªÉm: " + data.dealer_score;
            document.getElementById('bj-controls').style.display = 'none';
            document.getElementById('bj-btn-start').style.display = 'inline-block';
            setTimeout(() => alert(`K·∫æT QU·∫¢: ${data.result}`), 200);
        });
        socket.on('force_leave', (data) => { alert(data.msg); goHome(); });
        socket.on('error', (data) => alert(data.msg));

        // --- 2. C√ÅC H√ÄM ƒêI·ªÄU KHI·ªÇN S·∫¢NH CARO ---
        function showCaroMenu() {
            showScreen('caro-lobby');
        }

        // T·∫°o ph√≤ng Caro
        function createCaro(mode) {
            const name = document.getElementById('username').value;
            socket.emit('create_caro', {mode: mode, name: name});
        }

        // V√†o ph√≤ng b·∫±ng c√°ch nh·∫≠p m√£
        function joinCaroByInput() {
            const code = document.getElementById('caro-code-input').value.toUpperCase();
            const name = document.getElementById('username').value;
            if(!code) return alert("Vui l√≤ng nh·∫≠p m√£ ph√≤ng!");
            socket.emit('join_caro', {code: code, name: name});
        }

        // V√†o ph√≤ng b·∫±ng c√°ch b·∫•m v√†o danh s√°ch
        function joinCaroRoom(id) {
            const name = document.getElementById('username').value;
            socket.emit('join_caro', {code: id, name: name});
        }
        // --- LOGIC CARO (Th√™m v√†o cu·ªëi script) ---
        
        // 1. V·∫Ω b√†n c·ªù 15x15
        function initCaroBoard() {
            const boardDiv = document.getElementById('caro-board');
            boardDiv.innerHTML = '';
            for(let r=0; r<15; r++){
                for(let c=0; c<15; c++){
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.id = `c-${r}-${c}`;
                    cell.onclick = () => socket.emit('caro_move', {r: r, c: c});
                    boardDiv.appendChild(cell);
                }
            }
        }

        // 2. C·∫≠p nh·∫≠t s·ª± ki·ªán room_joined ƒë·ªÉ nh·∫≠n bi·∫øt game Caro
        // (B·∫°n c·∫ßn S·ª¨A L·∫†I ƒëo·∫°n socket.on('room_joined') c≈© th√†nh ƒëo·∫°n n√†y)
        socket.off('room_joined'); // T·∫Øt listener c≈© ƒëi cho ch·∫Øc
        socket.on('room_joined', (data) => {
            if(data.game_type === 'tienlen') {
                showScreen('tlmn-game');
                document.getElementById('rid-display').innerText = "Ph√≤ng: " + data.room_id;
                
                // --- TH√äM D√íNG N√ÄY ---
                // ·∫®n ngay n√∫t B·∫Øt ƒë·∫ßu/Ch∆°i l·∫°i ƒë·ªÉ x√≥a tr·∫°ng th√°i c≈©
                const startBtn = document.getElementById('btn-start');
                startBtn.style.display = 'none'; 
                startBtn.innerText = 'B·∫ÆT ƒê·∫¶U'; // Reset ch·ªØ v·ªÅ m·∫∑c ƒë·ªãnh
                // ---------------------
                
            } else if (data.game_type === 'caro') {
                showScreen('caro-game');
                document.getElementById('caro-rid').innerText = data.room_id;
                initCaroBoard(); 
            }
        });

        // 3. Nh·∫≠n c·∫≠p nh·∫≠t b√†n c·ªù t·ª´ Server
        // Update b√†n c·ªù Caro
   
        socket.on('caro_update', (data) => {
            // 1. Reset b√†n c·ªù (x√≥a X/O c≈©)
            document.querySelectorAll('.cell').forEach(c => {
                c.innerText = ''; 
                c.className='cell'; 
            });
            
            // 2. ƒêi·ªÅn X/O m·ªõi
            data.board.forEach(item => {
                const [pos, val] = item; 
                const cell = document.getElementById(`c-${pos[0]}-${pos[1]}`);
                if(cell) {
                    cell.innerText = val;
                    cell.classList.add(val.toLowerCase());
                }
            });

            // --- ƒêO·∫†N N√ÄY ƒê·ªÇ T√î M√ÄU √î V·ª™A ƒê√ÅNH ---
            if (data.last_move) {
                const [r, c] = data.last_move;
                const lastCell = document.getElementById(`c-${r}-${c}`);
                if (lastCell) {
                    lastCell.classList.add('last-move'); // Th√™m class ph√°t s√°ng
                }
            }

            // 3. C·∫≠p nh·∫≠t T√äN & G√ÅN ID CHAT (S·ª¨A L·∫†I TO√ÄN B·ªò PH·∫¶N N√ÄY)
            // -----------------------------------------------------------
            if (data.names) {
                // Hi·ªÉn th·ªã t√™n
                document.getElementById('player-x').innerText = 'X: ' + data.names.X;
                document.getElementById('player-o').innerText = 'O: ' + data.names.O;
            }

            // G√°n ID cho bong b√≥ng Chat d·ª±a tr√™n danh s√°ch players
            // (Server g·ª≠i: players = {'sid1': {'name': 'A', 'symbol': 'X'}, ...})
            if (data.players) {
                for (const [sid, p] of Object.entries(data.players)) {
                    if (p.symbol === 'X') {
                        // T√¨m bong b√≥ng c·ªßa X v√† g√°n ID
                        const bubble = document.querySelector('#wrapper-x .chat-bubble');
                        if(bubble) bubble.id = `chat-bubble-${sid}`;
                    } else if (p.symbol === 'O') {
                        // T√¨m bong b√≥ng c·ªßa O v√† g√°n ID
                        const bubble = document.querySelector('#wrapper-o .chat-bubble');
                        if(bubble) bubble.id = `chat-bubble-${sid}`;
                    }
                }
            }
            // -----------------------------------------------------------

            // 4. Highlight l∆∞·ª£t ƒëi
            const px = document.getElementById('player-x');
            const po = document.getElementById('player-o');

            if(data.turn === 'X') { 
                px.classList.add('active-turn-box'); 
                po.classList.remove('active-turn-box'); 
            } else { 
                po.classList.add('active-turn-box'); 
                px.classList.remove('active-turn-box'); 
            }

            // 5. Th·∫Øng thua
            const controls = document.getElementById('caro-controls');
            if(data.winner) {
                controls.style.display = 'block';
                const winnerName = data.names ? data.names[data.winner] : data.winner;
                setTimeout(() => alert(`üèÜ CH√öC M·ª™NG! ${winnerName} (${data.winner}) ƒê√É CHI·∫æN TH·∫ÆNG!`), 100);
            } else {
                controls.style.display = 'none';
            }
        });
        // --- LOGIC CHAT RI√äNG CHO CARO ---
        
        function toggleCaroChat() {
            const popup = document.getElementById('caro-chat-popup');
            popup.style.display = (popup.style.display === 'grid') ? 'none' : 'grid';
            if (popup.style.display === 'grid') document.getElementById('caro-chat-msg').focus();
        }

        function sendCaroText() {
            const input = document.getElementById('caro-chat-msg');
            const text = input.value.trim();
            if (text) {
                sendCaroChat('text', text);
                input.value = '';
            }
        }

        function checkCaroEnter(e) {
            if (e.key === "Enter") sendCaroText();
        }

        function sendCaroChat(type, content) {
            // T·∫≠n d·ª•ng l·∫°i s·ª± ki·ªán send_chat c·ªßa server (n√≥ d√πng chung cho m·ªçi game)
            socket.emit('send_chat', {type: type, content: content});
            toggleCaroChat(); // ƒê√≥ng popup sau khi ch·ªçn sticker
        }
    </script>
</body>
</html>